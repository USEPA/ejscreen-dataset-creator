# EJScreenDatasetCreator

## Description
`EJScreenDatasetCreator` is a python tool that automates the calculation of EJScreen indexes(`calIndexes`), percentiles(`percentileCal`/`percentileCalState`), bin/text fields(`calBinTxt`), and lookup tables to create the production EJScreen 2023 dataset. There is also the option join the resultant table to matching block groups or tracts to create a feature class within an Esri file geodatabase(`exportSpatial`).

## Python Package Requirements
All required packages come preinstalled in the default ArcGIS Pro 3.1 environment, which includes python 3. The following are the packages and versions used in the development of this tool. 

| Package       | Version       | 
| ------------- |--------------:|
| python        | 3.9.16        | 
| pandas        | 1.4.4         | 
| numpy         | 1.20.1        | 
| arcgis        | 2.1.0.2       |  
| arcpy         | 3.1           |

ArcGIS Pro is required to export the results to an Esri feature class. 
## Input Requirements

A csv file containing the required columns to generate an EJScreen dataset. These column names are designated in `col_names.py`. By default, the following columns are required:

| `col_names.info_names`       | `col_names.data_names`      | `col_names.extra_cols`      |
| ------------- | ------------- | ------------- |
| ID |  DEMOGIDX_2 | AREALAND | 
| STATE_NAME | DEMOGIDX_5 | AREAWATER | 
| ST_ABBREV | PEOPCOLORPCT | NPL_CNT | 
| CNTY_NAME | LOWINCPCT | TSDF_CNT | 
| REGION | UNEMPPCT | EXCEED_COUNT_80 | 
| ACSTOTPOP | LINGISOPCT | EXCEED_COUNT_80_SUP | 
| ACSIPOVBAS | LESSHSPCT | |
| ACSEDUCBAS | UNDER5PCT | |
| ACSTOTHH | OVER64PCT | |
| ACSTOTHU | LIFEEXPPCT | |
| ACSUNEMPBAS | PM25 | |
| PEOPCOLOR | OZONE | |
| LOWINCOME | DSLPM | |
| UNEMPLOYED | CANCER | |
| LINGISO | RESP | |
| LESSHS | RSEI_AIR | |
| UNDER5 | PTRAF | |
| OVER64 | PRE1960PCT | |
| PRE1960 | PNPL |  |
|  | PRMP | |
|  | PTSDF | |
|  | UST | |
|  | PWDIS | |

## How to Use
### Generate com
To run the tool, download the files to a local folder. From there, open `ejscreen_dataset.py` and update the following parameters:
* `option` - Must be a value of 1 or 2. If the value is 1, then percentiles will be calculated at the national level. If the value is 2, then percentiles will be calculated at the state level. 
* `input_ejscreen_csv` - file path to the input EJScreen dataset for which is used to generate the output
* `output_ejscreen_csv` - file path to output EJScreen csv file that will be generated by the tool
* `output_lookuptable_xlsx` - file path to output lookup table excel file that will be generated by the tool
* `output_to_featureclass` - True or False. If True, then join output EJScreen table to matching geometry based on "ID" column and export to  feature class
* `geometry_source_featureclass` - file path to block group/tract feature class that the output table will be joined to
* `output_featureclass_name` - file path to the output feature class that will be generated by the tool
* `schema_csv` - file path to schema csv file. This is used as part of the Batch Update Fields geoprocessing tool which sets field order, length, data type, and alias. `ejscreen_schema.csv` is included in this repository and can be used in this case. More information the Batch Update Fields tool can be found [here](https://pro.arcgis.com/en/pro-app/latest/tool-reference/data-management/batch-update-fields.htm).

Once the parameters have been updated, run the python file to generate the output. 

Additionally, if `EJScreenTool.py` is imported into a python script, the functions used to generate the final dataset can be used individually. Pandas dataframes are the primary input and output for each, and they also have the option to write the output to a csv file. The functions are:
* `percentileCal`/`percentileCalState` - returns 2 pandas dataframes; 1 containing the input DataFrame with percentile (P_) columns appended and 1 containing the lookup table for the columns for which percentiles were calculated
  * `ejscreen_data_df` - pandas DataFrame containing the EJScreen dataset
  * `output_csv_percentiles` - Default value: "". If `output` is set to true, the resultant percentile DataFrame will also be output as a csv file
  * `output_lookup_xlsx` - Default value: "". If `output` is set to true, the resultant lookup table DataFrame will also be output as an excel file
  * `output` - Default value: False. If set to True, the 2 resultant data frames of this function will also be output as a csv file and excel file respectively
  * percentile_column_names - Default value: col_names.data_names. A list of the columns within ejscreen_data_df that percentiles will be calculated for
* `calIndexes` - given an EJScreen dataset containing percentile columns, calculates both EJ and Supplemental index columns and returns a pandas DataFrame
  * `ejdf` - pandas DataFrame containing columns for the demographic indexes(DEMOGIDX_2, DEMOGIDX_5) and percentile(P_) columns for the environmental indicators
* `calBinTxt` - calculates bin(B_) and text(T_) fields for a pandas DataFrame containing EJScreen percentile columns. Returns a pandas DataFrame and the option to export result to csv file
  * `df` - pandas DataFrame containing EJScreen dataset with calculated percentile(P_) columns
  * `out_table` = Default value: "". File path to csv file that will be written from the output pandas DataFrame. Only writes if `output` parameter is set to True
  * `output` = Default value: False. If set to True, resultant DataFrame will be written to csv file
* `exportSpatial` - joins input geometry feature class and pandas DataFrame based on an ID column and exports the result to a feature class
  * `areas` - file path to feature class containing geometry that will be joined to input DataFrame
  * `data_df` - pandas DataFrame that will be joined to input feature class
  * `output_fc` - file path to the final feature class that will be written. Please note that if the `schema` is left empty, the output will be written to the same geodatabase as the source geometry as a feature class named "output".
  * `schema` - file path to schema csv file. This is used as part of the Batch Update Fields geoprocessing tool which sets field order, length, data type, and alias. `ejscreen_schema.csv` is included in this repository and can be used in this case. More information the Batch Update Fields tool can be found [here](https://pro.arcgis.com/en/pro-app/latest/tool-reference/data-management/batch-update-fields.htm).
  * `join_field` - the unique identifier field shared by both `areas` and `data_df` on which they will be joined.


## EPA Disclaimer
The United States Environmental Protection Agency (EPA) GitHub project code is provided on an "as is" basis and the user assumes responsibility for its use.  EPA has relinquished control of the information and no longer has responsibility to protect the integrity , confidentiality, or availability of the information.  Any reference to specific commercial products, processes, or services by service mark, trademark, manufacturer, or otherwise, does not constitute or imply their endorsement, recommendation or favoring by EPA.  The EPA seal and logo shall not be used in any manner to imply endorsement of any commercial product or activity by EPA or the United States Government. 


